
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Outward Management</title>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:10px;}
.container{max-width:1400px;margin:auto;background:white;border-radius:15px;box-shadow:0 15px 35px rgba(0,0,0,0.2);}
.header{background:linear-gradient(135deg,#1e3c72,#2a5298);color:white;padding:25px;text-align:center;}
.header h1{font-size:2em;}
.logout{position:absolute;top:20px;right:20px;padding:10px 20px;background:#f44336;color:white;border:none;border-radius:20px;cursor:pointer;}
.tabs{display:flex;background:#f5f5f5;border-bottom:2px solid #eee;}
.tab{flex:1;padding:15px;text-align:center;cursor:pointer;font-weight:600;color:#666;border-bottom:3px solid transparent;}
.tab:hover{background:#e9e9e9;}
.tab.active{color:#667eea;border-bottom-color:#667eea;background:white;}
.content{padding:25px;}
.tab-content{display:none;}
.tab-content.active{display:block;}
.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:15px;margin-bottom:25px;}
input,textarea,select{padding:12px;border:2px solid #ddd;border-radius:8px;font-size:15px;width:100%;}
input:focus,textarea:focus,select:focus{border-color:#667eea;box-shadow:0 0 5px rgba(102,126,234,0.3);outline:none;}
textarea{min-height:70px;}
.btn{padding:12px 30px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:25px;cursor:pointer;font-weight:600;font-size:15px;margin:5px;transition:all 0.3s;}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(102,126,234,0.4);}
.btn-success{background:linear-gradient(135deg,#4caf50,#45a049);}
.btn-warning{background:linear-gradient(135deg,#ff9800,#f57c00);}
.filters{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px;align-items:center;}
.filters input,.filters select{padding:10px;border:2px solid #ddd;border-radius:6px;width:auto;}
.table-wrap{overflow:auto;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.1);margin-bottom:20px;}
table{width:100%;border-collapse:collapse;background:white;min-width:900px;}
th{padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;text-align:left;font-weight:600;white-space:nowrap;}
td{padding:10px;border-bottom:1px solid #eee;}
tr:hover{background:#f8f9fa;}
.action-btn{padding:5px 12px;margin:0 2px;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;}
.edit-btn{background:#ff9800;color:white;}
.delete-btn{background:#f44336;color:white;}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:25px;}
.stat{background:linear-gradient(135deg,#f093fb,#f5576c);color:white;padding:20px;border-radius:12px;text-align:center;}
.stat h3{font-size:2.2em;margin-bottom:5px;}
.import-section{background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:20px;border:2px dashed #ddd;}
.file-label{display:inline-block;padding:12px 25px;background:#4caf50;color:white;border-radius:25px;cursor:pointer;font-weight:600;}
.import-progress{margin-top:10px;padding:10px;background:#e8f5e8;border-radius:5px;display:none;}
.activity-item{padding:15px;margin-bottom:10px;border-radius:8px;border-left:4px solid #667eea;background:white;box-shadow:0 2px 5px rgba(0,0,0,0.05);}
.activity-item.added{border-left-color:#4caf50;}
.activity-item.edited{border-left-color:#ff9800;}
.activity-item.deleted{border-left-color:#f44336;}
.activity-item.imported{border-left-color:#2196f3;}
.activity-header{display:flex;justify-content:space-between;font-size:13px;color:#666;margin-bottom:5px;}
.activity-details{font-weight:500;}
.sync-indicator{position:fixed;bottom:20px;right:20px;padding:12px 20px;border-radius:8px;color:white;font-weight:600;z-index:1000;display:none;}
.empty-state{text-align:center;padding:50px;color:#999;}
h2,h3{margin-bottom:20px;color:#333;}
#userInfo{margin-top:10px;font-size:14px;}
.login-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#1e3c72,#2a5298);display:flex;align-items:center;justify-content:center;z-index:99999;}.login-box{background:white;padding:40px;border-radius:15px;box-shadow:0 20px 50px rgba(0,0,0,0.4);text-align:center;max-width:380px;width:90%;}.login-box h2{font-size:1.8em;color:#1e3c72;margin-bottom:5px;}.login-box p{color:#999;margin-bottom:20px;font-size:13px;}.lbl{width:100%;padding:12px;margin:7px 0;border:2px solid #eee;border-radius:8px;font-size:15px;box-sizing:border-box;}.lbl:focus{border-color:#667eea;outline:none;}.lbtn{width:100%;padding:13px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer;margin-top:8px;}#lerr{color:#f44336;font-size:13px;margin-top:8px;}
</style>
</head>
<body>
<div id="lOverlay" class="login-overlay"><div class="login-box"><h2>üì¶ Login</h2><p>Cartridge Outward Management</p><input class="lbl" type="email" id="lEmail" placeholder="Email address"><input class="lbl" type="password" id="lPass" placeholder="Password"><button class="lbtn" id="lBtn">üîê LOGIN</button><p id="lerr"></p></div></div>
<div class="container" style="display:none;">
    <div class="header">
        <button class="logout" onclick="logout()">Logout</button>
        <h1>üì¶ Outward Management</h1>
        <p>Complete Working System - All Fixed</p>
        <div id="userInfo">üë®‚Äçüíº Admin</div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="showTab('entry')">üìù Entry</div>
        <div class="tab" onclick="showTab('records')">üìã Records (<span id="recordCount">0</span>)</div>
        <div class="tab" onclick="showTab('reports')">üìä Reports</div>
        <div class="tab" onclick="showTab('activity')">üìú Activity (<span id="activityCount">0</span>)</div>
    </div>

    <div class="content">
        <div id="entry" class="tab-content active">
            <h2>‚ûï New Entry</h2>
            <div class="import-section">
                <h3>üì§ Import Excel</h3>
                <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="importExcel(event)" style="display:none;">
                <label for="excelFile" class="file-label">üìÇ Choose Excel File</label>
                <div style="margin-top:10px;color:#666;font-size:14px;">Format: Date|Model|Qty|Serial|Address|DC|GEM|Docket</div>
                <div id="importProgress" class="import-progress"></div>
            </div>
            <form onsubmit="saveEntry(event)">
                <div class="form-row">
                    <div><label>Date *</label><input type="date" id="date" required></div>
                    <div><label>Model *</label><input type="text" id="model" required></div>
                    <div><label>Make Model</label><input type="text" id="makeModel" placeholder="HP CF283A"></div>
                    <div><label>Cartridge Type</label><input type="text" id="cartridgeType" placeholder="Toner/Ink"></div>
                    <div><label>Qty *</label><input type="number" id="qty" min="1" required></div>
                    <div><label>Serial No</label><input type="text" id="serialNo"></div>
                    <div><label>Address</label><textarea id="address"></textarea></div>
                    <div><label>DC No</label><input type="text" id="dcNo"></div>
                    <div><label>GEM Invoice</label><input type="text" id="gemInvoice"></div>
                    <div><label>Docket</label><input type="text" id="docket"></div>
                </div>
                <div style="text-align:center;">
                    <button type="submit" class="btn btn-success">üíæ Save Entry</button>
                    <button type="button" class="btn" onclick="resetForm()">üîÑ Reset</button>
                </div>
            </form>
        </div>

        <div id="records" class="tab-content">
            <h2>üìã All Records</h2>
            <div class="filters">
                <input type="date" id="fDateFrom" placeholder="From Date">
                <input type="date" id="fDateTo" placeholder="To Date">
                <input type="text" id="fModel" placeholder="Search Model" style="min-width:200px;">
                <button class="btn" onclick="filterRecords()">üîç Filter</button>
                <button class="btn btn-success" onclick="exportRecordsExcel()">üì• Export Excel</button>
                <button class="btn" onclick="clearRecordsFilter()">‚úñ Clear</button>
            </div>
            <div id="recordsList"></div>
        </div>

        <div id="reports" class="tab-content">
            <h2>üìä Reports & Analytics</h2>
            <div class="stats" id="stats"></div>
            <h3>üìÖ Daily Activity Report</h3>
            <div class="filters">
                <input type="date" id="reportDate">
                <button class="btn" onclick="showDailyReport()">üìä Generate Report</button>
                <button class="btn btn-warning" onclick="exportDetailedPDF()">üìÑ Export Detailed PDF</button>
            </div>
            <div id="dailyReport"></div>
            <h3 style="margin-top:30px;">üì¶ Model-wise Summary</h3>
            <div id="modelReport"></div>
        </div>

        <div id="activity" class="tab-content">
            <h2>üìú Activity Log</h2>
            <div class="filters">
                <input type="date" id="aDate">
                <select id="aType">
                    <option value="">All Activities</option>
                    <option value="added">Added</option>
                    <option value="edited">Edited</option>
                    <option value="deleted">Deleted</option>
                    <option value="imported">Imported</option>
                </select>
                <button class="btn" onclick="filterActivity()">üîç Filter</button>
                <button class="btn" onclick="clearActivityFilter()">‚úñ Clear</button>
            </div>
            <div id="activityList"></div>
        </div>
    </div>
</div>
<div id="sync" class="sync-indicator"></div>

<script>
let data=[],logs=[],editId=null;

function init(){
    document.getElementById('date').valueAsDate=new Date();
    document.getElementById('reportDate').valueAsDate=new Date();
    loadStorage();
    showTab('entry');
}
function loadStorage(){
  // Local first
  const d=localStorage.getItem('data'); if(d)data=JSON.parse(d);
  const l=localStorage.getItem('logs'); if(l)logs=JSON.parse(l);
  
  // Firebase only if loaded
  if(window.firebase && firebase.database){
    try{
      var db=firebase.database();
      db.ref('outward').on('value',snap=>{
        if(snap.val()){ data=snap.val(); localStorage.setItem('data',JSON.stringify(data)); updateCounts(); showRecords(); }
      });
    }catch(e){console.log('Firebase offline:',e);}
  }
}


function saveData(){
  localStorage.setItem('data',JSON.stringify(data)); updateCounts();
  if(typeof firebase!=='undefined'){
    var db=firebase.database(); db.ref('outward').set(data);
  }
}

    updateCounts();

function updateCounts(){
    document.getElementById('recordCount').textContent=data.length;
    document.getElementById('activityCount').textContent=logs.length;
}

function showTab(tab){
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
    try{if(event&&event.target&&event.target.classList)event.target.classList.add('active');}catch(ex){}
    if(tab==='records')showRecords();
    if(tab==='reports')showReports();
    if(tab==='activity')showActivity();
}

function saveEntry(e){
    e.preventDefault();
    const entry={
        id:editId||Date.now(),
        date:document.getElementById('date').value,
        model:document.getElementById('model').value.trim(),
        makeModel:document.getElementById('makeModel').value.trim(),
        cartridgeType:document.getElementById('cartridgeType').value.trim(),
        qty:+document.getElementById('qty').value,
        serialNo:document.getElementById('serialNo').value.trim(),
        address:document.getElementById('address').value.trim(),
        dcNo:document.getElementById('dcNo').value.trim(),
        gemInvoice:document.getElementById('gemInvoice').value.trim(),
        docket:document.getElementById('docket').value.trim()
    };

    if(editId){
        const i=data.findIndex(r=>r.id===editId);
        data[i]=entry;
        addLog('edited','Edited: '+entry.model);
    }else{
        data.push(entry);
        addLog('added','Added: '+entry.model+' (Qty: '+entry.qty+')');
    }
    saveData();
    resetForm();
    showSync('‚úÖ Entry Saved!','success');
    showTab('records');
}

function resetForm(){
    document.querySelector('form').reset();
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('makeModel').value = '';
    document.getElementById('cartridgeType').value = '';
    editId = null;
}

function showRecords(fdata=null){
    const list=document.getElementById('recordsList');
    const displayData=fdata||data;
    document.getElementById('recordCount').textContent=data.length;

    if(displayData.length===0){
        list.innerHTML='<div class="empty-state"><h3>üì≠ No Records Found</h3><p>Add entries or import Excel to see records</p></div>';
        return;
    }

    let html='<div class="table-wrap"><table><thead><tr>';
    html+='<th>Date</th><th>Model</th><th>Make Model</th><th>Cartridge Type</th><th>Qty</th><th>Serial No</th><th>Address</th><th>DC No</th><th>GEM Invoice</th><th>Docket</th><th>Actions</th>';
    html+='</tr></thead><tbody>';

    displayData.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(r=>{
        html+=`<tr>
            <td>${new Date(r.date).toLocaleDateString('hi-IN')}</td>
            <td><strong>${r.model}</strong></td>
            <td>${r.makeModel||'-'}</td>
            <td>${r.cartridgeType||'-'}</td>
            <td style="color:#4caf50;font-weight:600;">${r.qty}</td>
            <td>${r.serialNo||'-'}</td>
            <td>${r.address||'-'}</td>
            <td>${r.dcNo||'-'}</td>
            <td>${r.gemInvoice||'-'}</td>
            <td>${r.docket||'-'}</td>
            <td style="white-space:nowrap;">
                <button class="action-btn edit-btn" onclick="editRecord(${r.id})">Edit</button>
                <button class="action-btn delete-btn" onclick="deleteRecord(${r.id})">Delete</button>
            </td>
        </tr>`;
    });
    html+='</tbody></table></div>';
    list.innerHTML=html;
}

function filterRecords(){
    const from=document.getElementById('fDateFrom').value;
    const to=document.getElementById('fDateTo').value;
    const model=document.getElementById('fModel').value.toLowerCase().trim();

    const filtered=data.filter(r=>{
        if(from && r.date<from)return false;
        if(to && r.date>to)return false;
        if(model && !r.model.toLowerCase().includes(model))return false;
        return true;
    });

    showRecords(filtered);
    showSync(`üîç Found ${filtered.length} records`,'success');
}

function clearRecordsFilter(){
    document.getElementById('fDateFrom').value='';
    document.getElementById('fDateTo').value='';
    document.getElementById('fModel').value='';
    showRecords();
    showSync('‚úñ Filters cleared','success');
}

function exportRecordsExcel(){
    if(data.length===0){
        showSync('‚ùå No records to export!','error');
        return;
    }
    const wb=XLSX.utils.book_new();
    const ws=XLSX.utils.aoa_to_sheet([
        ['Date','Model','Qty','Serial No','Address','DC No','GEM Invoice','Docket'],
        ...data.map(r=>[r.date,r.model,r.qty,r.serialNo,r.address,r.dcNo,r.gemInvoice,r.docket])
    ]);
    XLSX.utils.book_append_sheet(wb,ws,'Records');
    XLSX.writeFile(wb,`outward-records-${new Date().toISOString().split('T')[0]}.xlsx`);
    showSync('üì• Excel exported successfully!','success');
}

function showReports(){
    const total=data.length;
    const qty=data.reduce((s,r)=>s+r.qty,0);
    const models=new Set(data.map(r=>r.model)).size;
    document.getElementById('stats').innerHTML=`
        <div class="stat"><h3>${total}</h3><p>Total Records</p></div>
        <div class="stat" style="background:linear-gradient(135deg,#4facfe,#00f2fe);"><h3>${qty}</h3><p>Total Quantity</p></div>
        <div class="stat" style="background:linear-gradient(135deg,#43e97b,#38f9d7);"><h3>${models}</h3><p>Unique Models</p></div>
    `;
    showDailyReport();
    showModelReport();
}

function showDailyReport(){
    const date=document.getElementById('reportDate').value;
    const dayLogs=logs.filter(l=>new Date(l.time).toISOString().split('T')[0]===date);
    const cont=document.getElementById('dailyReport');

    if(dayLogs.length===0){
        cont.innerHTML='<div class="empty-state"><h3>üì≠ No activity on this date</h3></div>';
        return;
    }

    let html='<div class="table-wrap"><table><thead><tr><th>Time</th><th>Type</th><th>Details</th></tr></thead><tbody>';
    dayLogs.slice().reverse().forEach(l=>{
        html+=`<tr>
            <td>${new Date(l.time).toLocaleTimeString('hi-IN')}</td>
            <td><strong>${l.type.toUpperCase()}</strong></td>
            <td>${l.details}</td>
        </tr>`;
    });
    html+='</tbody></table></div>';
    cont.innerHTML=html;
}

function showModelReport(){
    const modelData={};
    data.forEach(r=>{
        if(!modelData[r.model])modelData[r.model]={qty:0,count:0};
        modelData[r.model].qty+=r.qty;
        modelData[r.model].count++;
    });

    let html='<div class="table-wrap"><table><thead><tr><th>Model</th><th>Total Qty</th><th>Entries</th></tr></thead><tbody>';
    Object.entries(modelData).sort((a,b)=>b[1].qty-a[1].qty).forEach(([m,d])=>{
        html+=`<tr><td><strong>${m}</strong></td><td style="color:#4caf50;font-weight:600;">${d.qty}</td><td>${d.count}</td></tr>`;
    });
    html+='</tbody></table></div>';
    document.getElementById('modelReport').innerHTML=html;
}

function exportDetailedPDF(){
    if(data.length===0){
        showSync('‚ùå No data to export!','error');
        return;
    }

    const date=document.getElementById('reportDate').value;
    const dayData=data.filter(r=>r.date===date);
    const dayLogs=logs.filter(l=>new Date(l.time).toISOString().split('T')[0]===date);

    let html=`<!DOCTYPE html><html><head><meta charset="UTF-8">
<title>Outward Report - ${new Date(date).toLocaleDateString('hi-IN')}</title>
<style>
body{font-family:Arial,sans-serif;margin:30px;background:white;line-height:1.6;}
h1{text-align:center;color:#1e3c72;border-bottom:3px solid #667eea;padding-bottom:10px;}
h2{color:#333;margin-top:30px;background:#f5f5f5;padding:10px;border-left:5px solid #667eea;}
table{width:100%;border-collapse:collapse;margin:20px 0;font-size:14px;}
th,td{border:1px solid #ddd;padding:10px;text-align:left;}
th{background:#667eea;color:white;font-weight:600;}
tr:nth-child(even){background:#f9f9f9;}
.summary{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin:20px 0;}
.summary-box{background:#f5f5f5;padding:15px;border-radius:8px;text-align:center;border-left:5px solid #667eea;}
.summary-box h3{font-size:2em;margin:0;color:#667eea;}
.summary-box p{margin:5px 0 0;color:#666;}
.log-item{padding:12px;margin:10px 0;border-left:5px solid;background:#f9f9f9;border-radius:5px;}
.log-item.added{border-color:#4caf50;background:#e8f5e9;}
.log-item.edited{border-color:#ff9800;background:#fff3e0;}
.log-item.deleted{border-color:#f44336;background:#ffebee;}
.log-item.imported{border-color:#2196f3;background:#e3f2fd;}
@media print{body{margin:15px;}.no-print{display:none;}}
.login-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#1e3c72,#2a5298);display:flex;align-items:center;justify-content:center;z-index:99999;}.login-box{background:white;padding:40px;border-radius:15px;box-shadow:0 20px 50px rgba(0,0,0,0.4);text-align:center;max-width:380px;width:90%;}.login-box h2{font-size:1.8em;color:#1e3c72;margin-bottom:5px;}.login-box p{color:#999;margin-bottom:20px;font-size:13px;}.lbl{width:100%;padding:12px;margin:7px 0;border:2px solid #eee;border-radius:8px;font-size:15px;box-sizing:border-box;}.lbl:focus{border-color:#667eea;outline:none;}.lbtn{width:100%;padding:13px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer;margin-top:8px;}#lerr{color:#f44336;font-size:13px;margin-top:8px;}
</style>
</head><body>
<h1>üì¶ Daily Outward Report</h1>
<p style="text-align:center;font-size:18px;color:#666;">Date: ${new Date(date).toLocaleDateString('hi-IN',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</p>

<div class="summary">
    <div class="summary-box"><h3>${dayData.length}</h3><p>Records Today</p></div>
    <div class="summary-box"><h3>${dayData.reduce((s,r)=>s+r.qty,0)}</h3><p>Total Quantity</p></div>
    <div class="summary-box"><h3>${dayLogs.length}</h3><p>Activities</p></div>
</div>

<h2>üìã Outward Entries (${dayData.length} records)</h2>
<table>
<thead><tr>
    <th>Date</th><th>Model</th><th>Qty</th><th>Serial No</th><th>Address</th><th>DC No</th><th>GEM Invoice</th><th>Docket</th>
</tr></thead>
<tbody>`;

    if(dayData.length>0){
        dayData.forEach(r=>{
            html+=`<tr>
                <td>${new Date(r.date).toLocaleDateString('hi-IN')}</td>
                <td><strong>${r.model}</strong></td>
                <td style="color:#4caf50;font-weight:600;">${r.qty}</td>
                <td>${r.serialNo||'-'}</td>
                <td>${r.address||'-'}</td>
                <td>${r.dcNo||'-'}</td>
                <td>${r.gemInvoice||'-'}</td>
                <td>${r.docket||'-'}</td>
            </tr>`;
        });
    }else{
        html+='<tr><td colspan="8" style="text-align:center;color:#999;">No entries for this date</td></tr>';
    }

    html+=`</tbody></table>

<h2>üìú Activity Log (${dayLogs.length} activities)</h2>`;

    if(dayLogs.length>0){
        dayLogs.slice().reverse().forEach(l=>{
            html+=`<div class="log-item ${l.type}">
                <strong>${l.type.toUpperCase()}</strong> | 
                ${new Date(l.time).toLocaleString('hi-IN')} | 
                ${l.details}
            </div>`;
        });
    }else{
        html+='<p style="text-align:center;color:#999;padding:20px;">No activity for this date</p>';
    }

    html+=`
<div style="margin-top:50px;text-align:center;color:#999;border-top:2px solid #eee;padding-top:20px;">
    <p>Generated on ${new Date().toLocaleString('hi-IN')}</p>
    <p class="no-print">Press <strong>Ctrl+P</strong> to save as PDF</p>
</div>
</body></html>`;

    const blob=new Blob([html],{type:'text/html'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download=`outward-report-${date}.html`;
    a.click();
    showSync('üìÑ PDF Report ready! Open file & Ctrl+P','success');
}

function showActivity(flogs=null){
    const displayLogs=flogs||logs;
    document.getElementById('activityCount').textContent=logs.length;
    const list=document.getElementById('activityList');

    if(displayLogs.length===0){
        list.innerHTML='<div class="empty-state"><h3>üì≠ No Activity Yet</h3><p>Activity will appear when you add/edit/delete records</p></div>';
        return;
    }

    let html='';
    displayLogs.slice().reverse().forEach(l=>{
        html+=`<div class="activity-item ${l.type}">
            <div class="activity-header">
                <span><strong>${l.type.toUpperCase()}</strong></span>
                <span>${new Date(l.time).toLocaleString('hi-IN')}</span>
            </div>
            <div class="activity-details">${l.details}</div>
        </div>`;
    });
    list.innerHTML=html;
}

function filterActivity(){
    const date=document.getElementById('aDate').value;
    const type=document.getElementById('aType').value;

    const filtered=logs.filter(l=>{
        if(date && new Date(l.time).toISOString().split('T')[0]!==date)return false;
        if(type && l.type!==type)return false;
        return true;
    });

    showActivity(filtered);
    showSync(`üîç Found ${filtered.length} activities`,'success');
}

function clearActivityFilter(){
    document.getElementById('aDate').value='';
    document.getElementById('aType').value='';
    showActivity();
    showSync('‚úñ Filters cleared','success');
}

function addLog(type,details){
    logs.push({id:Date.now(),type,details,time:new Date().toISOString()});
    saveLogs();
    updateCounts();
}

function saveData(){
    localStorage.setItem('data',JSON.stringify(data));
    updateCounts();
    db.ref('outward').set(data);
}
function saveLogs(){localStorage.setItem('logs',JSON.stringify(logs));}

function showSync(msg,type){
    const el=document.getElementById('sync');
    el.textContent=msg;
    el.style.background=type==='success'?'#4caf50':'#f44336';
    el.style.display='block';
    setTimeout(()=>el.style.display='none',3000);
}

function editRecord(id){
    const r=data.find(d=>d.id===id);
    if(!r)return;
    document.getElementById('date').value=r.date;
    document.getElementById('model').value=r.model;
    document.getElementById('makeModel').value = r.makeModel || '';
    document.getElementById('cartridgeType').value = r.cartridgeType || '';
    document.getElementById('qty').value=r.qty;
    document.getElementById('serialNo').value=r.serialNo;
    document.getElementById('address').value=r.address;
    document.getElementById('dcNo').value=r.dcNo;
    document.getElementById('gemInvoice').value=r.gemInvoice;
    document.getElementById('docket').value=r.docket;
    editId=id;
    showTab('entry');
}

function deleteRecord(id){
    if(!confirm('üóëÔ∏è Delete this record?'))return;
    const r=data.find(d=>d.id===id);
    data=data.filter(d=>d.id!==id);
    addLog('deleted','Deleted: '+r.model+' (Qty: '+r.qty+')');
    saveData();
    showRecords();
    showSync('üóëÔ∏è Record deleted!','success');
}

function importExcel(e){
    const file=e.target.files[0];
    if(!file)return;
    if(!file.name.match(/\.xlsx?$/i)){
        showSync('‚ùå Only Excel files allowed!','error');
        e.target.value='';
        return;
    }

    const prog=document.getElementById('importProgress');
    prog.style.display='block';
    prog.innerHTML='üìä Reading Excel file...';

    const reader=new FileReader();
    reader.onload=ev=>{
        try{
            const wb=XLSX.read(new Uint8Array(ev.target.result),{type:'array'});
            const sh=wb.Sheets[wb.SheetNames[0]];
            const rows=XLSX.utils.sheet_to_json(sh,{header:1});
            let count=0;

            for(let i=1;i<rows.length;i++){
                const r=rows[i];
                if(!r||r.length<3)continue;

                let dateVal=r[0];
                let formattedDate='';
                if(typeof dateVal==='number'){
                    const d=XLSX.SSF.parse_date_code(dateVal);
                    formattedDate=d.y+'-'+String(d.m).padStart(2,'0')+'-'+String(d.d).padStart(2,'0');
                }else{
                    formattedDate=dateVal||new Date().toISOString().split('T')[0];
                }

                data.push({
                    id:Date.now()+i,
                    date:formattedDate,
                    model:r[1]?r[1].toString().trim():'',
                    qty:+r[2]||0,
                    serialNo:r[3]?r[3].toString().trim():'',
                    address:r[4]?r[4].toString().trim():'',
                    dcNo:r[5]?r[5].toString().trim():'',
                    gemInvoice:r[6]?r[6].toString().trim():'',
                    docket:r[7]?r[7].toString().trim():''
                });
                count++;
            }

            saveData();
            addLog('imported','Imported '+count+' records from Excel');
            prog.innerHTML='‚úÖ Successfully imported '+count+' records!';
            showSync('üéâ '+count+' records imported!','success');
            setTimeout(()=>{
                prog.style.display='none';
                e.target.value='';
                showTab('records');
            },2000);
        }catch(err){
            prog.innerHTML='‚ùå Error: '+err.message;
            setTimeout(()=>prog.style.display='none',3000);
        }
    };
    reader.readAsArrayBuffer(file);
}

function logout(){
    if(confirm('üö™ Logout?')){
        try{firebase.auth().signOut();}catch(e){}
        localStorage.clear();
        location.reload();
    }
}
window.onload=function(){};
</script>

<!-- Firebase Auth -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
(function(){
var cfg={apiKey:"AIzaSyBuB2g931JTbEM7o7DaQZKOL7IGH4FaU70",
  authDomain:"cwc-outword.firebaseapp.com",
  databaseURL:"https://cwc-outword-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId:"cwc-outword"
};
firebase.initializeApp(cfg);
var auth=firebase.auth();
var db=firebase.database(); 
// Firebase Login
document.getElementById('lBtn').onclick = function(){
  var email = document.getElementById('lEmail').value;
  var pass = document.getElementById('lPass').value;
  var err = document.getElementById('lerr');
  
  firebase.auth().signInWithEmailAndPassword(email, pass)
  .then(function(){
    document.getElementById('loginOverlay').style.display = 'none';
    document.querySelector('.container').style.display = 'block';
    document.getElementById('userInfo').innerHTML = 'Admin';
    init();
  })
  .catch(function(e){
    document.getElementById('lerr').innerHTML = '‚ùå ' + e.message;
  });
};

// Auto check login
firebase.auth().onAuthStateChanged(function(user){
  if(user){
    document.getElementById('loginOverlay').style.display = 'none';
    document.querySelector('.container').style.display = 'block';
    init();
  }
});
  if(user){
    document.getElementById('lOverlay').style.display='none';
    document.querySelector('.container').style.display='block';
    if(!window._s){window._s=true;init();}
  } else {
    document.getElementById('lOverlay').style.display='flex';
    document.querySelector('.container').style.display='none';
    window._s=false;
  }
});
})();
</script>
</body>
</html>
